version: 2.1

orbs:
  architect: giantswarm/architect@5.11.4
  python: circleci/python@3.0.0

jobs:
  build-and-test:
    executor: python/default

    steps:
    - checkout
    - python/install-packages:
        pkg-manager: pip
    - run:
        name: Run Python unit tests
        command: |
          python3 common_test.py
          python3 hugo_test.py

workflows:
  publish:
    jobs:
    - build-and-test:
        filters:
          tags:
            only: /^v.*/
    - architect/push-to-registries:
        context: architect
        name: push-to-registries
        requires:
        - build-and-test
        filters:
          tags:
            only: /^v.*/
          branches:
            only: /.*/
    - architect/push-to-app-catalog:
        name: push-to-app-catalog
        context: architect
        executor: app-build-suite
        app_catalog: giantswarm-operations-platform-catalog
        app_catalog_test: giantswarm-operations-platform-test-catalog
        chart: docs-indexer-app
        filters:
          tags:
            only: /^v.*/
          branches:
            only: /.*/
        requires:
        - push-to-registries
