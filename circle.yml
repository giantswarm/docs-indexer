machine:
  services:
    - docker

dependencies:
  override:
    - |
      wget -q $(curl -sS -H "Authorization: token $RELEASE_TOKEN" https://api.github.com/repos/giantswarm/architect/releases/latest | grep browser_download_url | head -n 1 | cut -d '"' -f 4)
    - chmod +x ./architect
    - ./architect version

    # fetch and configure kubectl
    - curl --silent --max-time 60 --remote-name https://storage.googleapis.com/kubernetes-release/release/v1.5.2/bin/linux/amd64/kubectl && chmod +x ./kubectl
    - echo $G8S_CA | base64 --decode --output ./ca.pem
    - echo $G8S_CRT | base64 --decode --output ./crt.pem
    - echo $G8S_KEY | base64 --decode --output ./key.pem
    - ./kubectl config set-cluster g8s-cluster --server=https://api.g8s.fra-1.giantswarm.io --certificate-authority=./ca.pem
    - ./kubectl config set-credentials g8s-admin --certificate-authority=./ca.pem --client-certificate=./crt.pem --client-key=./key.pem
    - ./kubectl config set-context g8s-system --cluster=g8s-cluster --user=g8s-admin
    - ./kubectl config use-context g8s-system
    - ./kubectl cluster-info

test:
  override:
    - ./architect build

deployment:
  master:
    branch: kubernetes
    commands:
      # Deleting existing job before applying manifests, as jobs can't be overwritten
      ./kubectl -n docs delete job --selector=component=docs-indexer
      - ./architect deploy
